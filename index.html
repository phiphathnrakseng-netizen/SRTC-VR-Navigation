<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>วิทยาลัยเทคนิคสุราษฎร์ธานี VR | ระบบนำทาง AR/VR</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5"> 
    
    <link rel="manifest" href="/manifest.json">
    
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #f3f4f6;
        }
        #main-content {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        #aframe-scene-container {
            width: 100%;
            height: 450px; 
            background-color: #f0f0f0; 
            border-radius: 1.5rem;
            overflow: hidden;
        }
        #ar-scene-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        .rounded-3xl {
            border-radius: 1.5rem;
        }
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
        }
        .building-marker {
            border: 2px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(79, 70, 229, 0.3);
            cursor: pointer;
        }
        .building-marker::after {
            content: '';
            width: 20px;
            height: 20px;
            background-color: #4f46e5;
            border-radius: 50%;
        }
        .navigation-path {
            position: absolute;
            height: 4px;
            background-color: #10b981;
            transform-origin: 0 0;
            z-index: 10;
        }
        
        /* ปรับปรุงการแสดงผลสำหรับมือถือ */
        @media (max-width: 640px) {
            #home-section h2 {
                font-size: 1.75rem;
                line-height: 2.25rem;
            }
            #home-section p {
                font-size: 1rem;
            }
            .section-content {
                padding: 1rem;
            }
            #building-list {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }
        
        /* ปรับปรุงสำหรับแท็บเล็ต */
        @media (min-width: 641px) and (max-width: 1024px) {
            #building-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ปรับปรุงสำหรับเดสก์ท็อป */
        @media (min-width: 1025px) {
            #building-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* ปรับปรุง Modal ให้พอดีกับหน้าจอ */
        .modal-container {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* ปรับปรุง Header ให้พอดีทุกอุปกรณ์ */
        header {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        /* ปรับปรุง Footer ให้อยู่ด้านล่างเสมอ */
        footer {
            margin-top: auto;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

<div id="main-content" class="flex flex-col min-h-screen w-full">
    <header class="bg-white shadow-xl sticky top-0 z-20 border-b border-indigo-100 w-full">
        <div class="w-full px-4 sm:px-6 lg:px-8 py-3 sm:py-4 flex justify-between items-center">
            
            <div class="flex items-center space-x-3">
                <img src="https://www.srtc.ac.th/2020/images/images.jpg" alt="ตราวิทยาลัยเทคนิคสุราษฎร์ธานี" class="h-10 w-10 sm:h-12 sm:w-12 rounded-full ring-2 ring-indigo-500 p-[2px]"> 
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900 tracking-wide">วิทยาลัยเทคนิคสุราษฎร์ธานี VR</h1>
            </div>
            
            <nav class="space-x-2 sm:space-x-4 flex items-center">
                <a href="#home" onclick="showSection('home-section')" class="text-gray-700 hover:text-indigo-600 transition duration-150 hidden lg:inline-block font-semibold py-2 px-3 rounded-xl" id="nav-home">หน้าแรก</a>
                
                <a href="#map" onclick="showSection('map-section')" class="text-gray-700 hover:text-indigo-600 transition duration-150 hidden lg:inline-block font-semibold py-2 px-3 rounded-xl" id="nav-map">แผนผัง</a>
                
                <button id="pwa-install-button" onclick="promptPWAInstall()" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 sm:px-4 rounded-3xl shadow-lg flex items-center space-x-2 transform transition duration-200 hover:scale-105 ring-1 ring-purple-300">
                    <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    <span class="text-xs sm:text-sm hidden sm:inline">ติดตั้ง PWA</span>
                </button>

                <button onclick="showModal('install-qr-modal')" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2 px-3 sm:px-4 rounded-3xl shadow-lg flex items-center space-x-2 transform transition duration-200 hover:scale-105 ring-1 ring-yellow-300">
                    <i data-lucide="qr-code" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    <span class="text-xs sm:text-sm hidden sm:inline">QR Code</span>
                </button>

                <button onclick="showCameraSelection()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 sm:px-4 rounded-3xl shadow-lg flex items-center space-x-2 transform transition duration-200 hover:scale-105 ring-1 ring-indigo-300">
                    <i data-lucide="scan" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                    <span class="text-xs sm:text-sm">AR นำทาง</span>
                </button>
            </nav>
        </div>
    </header>
    
    <div id="home-section" class="section-content flex-grow flex flex-col w-full">
        <section class="relative flex-grow flex items-center justify-center text-center overflow-hidden min-h-[calc(100vh-120px)] w-full">
            <img 
                src="https://images.unsplash.com/photo-1621905252507-b35492cc74b4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2069&q=80" 
                alt="วิทยาลัยเทคนิคสุราษฎร์ธานี" 
                class="absolute inset-0 h-full w-full object-cover blur-sm scale-110" >
            <div class="absolute inset-0 bg-indigo-900/80"></div>
            
            <div class="relative z-10 w-full max-w-2xl p-4 sm:p-6">
                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-white mb-4 leading-snug drop-shadow-lg">ระบบนำทางวิทยาลัยเทคนิคสุราษฎร์ธานี</h2>
                <p class="text-lg sm:text-xl text-indigo-200 mb-8">ด้วยเทคโนโลยี AR/VR ที่ทันสมัย</p>
                
                <div class="flex rounded-3xl shadow-2xl overflow-hidden max-w-md mx-auto ring-4 ring-indigo-300/50"> 
                    <input type="text" id="search-input" placeholder="ค้นหาห้องเรียน เช่น 201, ห้องปฏิบัติการคอมพิวเตอร์" class="w-full py-3 px-4 sm:px-6 text-gray-800 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 transition duration-150 text-base sm:text-lg focus:z-10" aria-label="Search">
                    <button onclick="searchRoom()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 sm:px-6 transition duration-150 flex items-center space-x-2">
                        <i data-lucide="search" class="w-5 h-5"></i>
                        <span class="hidden sm:inline">ค้นหา</span>
                    </button>
                </div>
                
                <button onclick="showSection('map-section')" class="mt-6 sm:mt-8 bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 sm:px-8 rounded-3xl shadow-xl transition duration-200 transform hover:scale-105 flex items-center justify-center mx-auto space-x-2 ring-2 ring-pink-300/50"> 
                    <i data-lucide="map" class="w-5 h-5"></i>
                    <span>ดูแผนผังวิทยาลัย</span>
                </button>
            </div>
        </section>
    </div>

    <div id="map-section" class="section-content hidden flex-grow p-4 sm:p-6 lg:p-8 w-full">
        <div class="w-full max-w-7xl mx-auto">
            <h2 class="text-2xl sm:text-3xl lg:text-4xl font-extrabold text-gray-900 mb-4 sm:mb-6 border-b-4 border-indigo-200 pb-2 flex items-center"> 
                <i data-lucide="layout-grid" class="w-6 h-6 sm:w-8 sm:h-8 mr-3 text-indigo-600"></i>
                แผนผังวิทยาลัยเทคนิคสุราษฎร์ธานี
            </h2>

            <p class="text-gray-600 mb-6 sm:mb-8 max-w-3xl">นี่คือรายการอาคารทั้งหมดของวิทยาลัยเทคนิคสุราษฎร์ธานี คุณสามารถกดที่อาคารเพื่อดูรายละเอียด และเข้าสู่โหมด 3D จำลองเสมือน</p>

            <div id="building-list" class="grid gap-4 sm:gap-6 lg:gap-8"> </div>
            
            <div class="mt-8 sm:mt-10 p-4 sm:p-6 bg-yellow-50 border-l-8 border-yellow-500 rounded-2xl shadow-md"> 
                <p class="text-yellow-800 font-semibold flex items-start">
                    <i data-lucide="info" class="w-5 h-5 mr-3 mt-1 flex-shrink-0"></i>
                    หมายเหตุ: ระบบนำทาง AR ต้องการการอนุญาตใช้งานกล้องและเซ็นเซอร์ของอุปกรณ์
                </p>
            </div>
        </div>
    </div>

    <footer class="bg-gray-900 text-white py-4 mt-auto shadow-inner w-full">
        <div class="text-center text-sm">
            © 2025 วิทยาลัยเทคนิคสุราษฎร์ธานี - แผนกเทคโนโลยีสารสนเทศ
        </div>
    </footer>
</div>

<!-- Modal เลือกกล้อง -->
<div id="camera-selection-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-6 sm:p-8 transform transition-all duration-300 scale-95 opacity-0" data-modal-target> 
        <div class="flex justify-between items-start mb-4 border-b pb-2">
            <h3 class="text-2xl font-bold text-indigo-700 flex items-center">
                <i data-lucide="camera" class="w-6 h-6 mr-2 text-indigo-500"></i>
                เลือกกล้อง
            </h3>
            <button onclick="hideModal('camera-selection-modal')" class="text-gray-500 hover:text-gray-900 transition p-1 rounded-full hover:bg-gray-100">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <p class="text-gray-600 mb-6">เลือกกล้องที่ต้องการใช้สำหรับโหมด AR/VR</p>

        <div class="space-y-4">
            <button onclick="toggleVRMode('environment')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition duration-150 flex items-center justify-center space-x-3 transform hover:scale-[1.02]">
                <i data-lucide="camera" class="w-6 h-6"></i>
                <div class="text-left">
                    <div class="font-semibold">กล้องหลัง (สำหรับ AR)</div>
                    <div class="text-sm opacity-90">เหมาะสำหรับการนำทางด้วย AR</div>
                </div>
            </button>
            
            <button onclick="toggleVRMode('user')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition duration-150 flex items-center justify-center space-x-3 transform hover:scale-[1.02]">
                <i data-lucide="user" class="w-6 h-6"></i>
                <div class="text-left">
                    <div class="font-semibold">กล้องหน้า (สำหรับคอมพิวเตอร์)</div>
                    <div class="text-sm opacity-90">เหมาะสำหรับการใช้งานบนคอมพิวเตอร์</div>
                </div>
            </button>
            
            <button onclick="hideModal('camera-selection-modal')" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-2xl transition duration-150">
                ยกเลิก
            </button>
        </div>
    </div>
</div>

<!-- Modal ติดตั้งแอปและ QR Code -->
<div id="install-qr-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full p-6 sm:p-8 transform transition-all duration-300 scale-95 opacity-0 modal-container" data-modal-target> 
        <div class="flex justify-between items-start mb-4 border-b pb-2">
            <h3 class="text-2xl font-bold text-indigo-700 flex items-center">
                <i data-lucide="download-cloud" class="w-6 h-6 mr-2 text-indigo-500"></i>
                ติดตั้งแอปพลิเคชัน / สแกน QR Code
            </h3>
            <button onclick="hideModal('install-qr-modal')" class="text-gray-500 hover:text-gray-900 transition p-1 rounded-full hover:bg-gray-100">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <p class="text-gray-600 mb-6">คุณสามารถติดตั้งแอปพลิเคชันนี้บนมือถือของคุณได้ด้วยวิธีใดวิธีหนึ่งด้านล่างนี้:</p>

        <div class="bg-indigo-50 p-4 sm:p-6 rounded-2xl mb-6 flex flex-col items-center border border-indigo-200 shadow-inner"> 
            <h4 class="font-semibold text-xl text-indigo-800 mb-3 flex items-center">
                <i data-lucide="scan" class="w-5 h-5 mr-2"></i>
                สแกน QR Code สำหรับลิงก์เว็บไซต์
            </h4>
            <div id="qrcode-display" class="my-4 p-4 bg-white rounded-xl shadow-lg inline-block ring-2 ring-indigo-200"> 
                <div class="text-gray-500 text-sm">กำลังสร้าง QR Code...</div>
            </div>
            
            <button id="qr-download-btn" onclick="downloadQRCode()" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-150 shadow-md transform hover:scale-105">
                <i data-lucide="download" class="inline w-5 h-5 mr-1"></i>
                ดาวน์โหลด QR Code (PNG)
            </button>
        </div>

        <h4 class="font-semibold text-xl text-indigo-700 mb-4 flex items-center border-b pb-2">
            <i data-lucide="smartphone" class="w-5 h-5 mr-2"></i>
            คำแนะนำการติดตั้ง PWA
        </h4>
        <div class="space-y-4">
            <div class="bg-gray-100 p-4 rounded-xl border-l-4 border-indigo-500 shadow-sm"> 
                <h5 class="font-semibold text-lg text-indigo-700 mb-2">สำหรับ iPhone (iOS)</h5>
                <ol class="list-decimal list-inside text-gray-700 space-y-1 text-sm sm:text-base">
                    <li>เปิดเว็บไซต์ด้วยเบราว์เซอร์ <strong>Safari</strong></li>
                    <li>แตะที่ <strong>ปุ่มแชร์</strong> (<i data-lucide="share" class="inline w-4 h-4 text-indigo-500"></i>) ที่อยู่ด้านล่างของหน้าจอ</li>
                    <li>เลื่อนลงและเลือก <strong>เพิ่มไปยังหน้าจอโฮม</strong> (Add to Home Screen)</li>
                </ol>
            </div>

            <div class="bg-gray-100 p-4 rounded-xl border-l-4 border-green-500 shadow-sm"> 
                <h5 class="font-semibold text-lg text-green-700 mb-2">สำหรับ Android</h5>
                <ol class="list-decimal list-inside text-gray-700 space-y-1 text-sm sm:text-base">
                    <li>เปิดเว็บไซต์ด้วยเบราว์เซอร์ <strong>Chrome</strong></li>
                    <li>แตะที่ <strong>ปุ่มเมนู</strong> (จุดสามจุด) ที่มุมขวาบน</li>
                    <li>เลือก <strong>ติดตั้งแอป</strong> หรือ <strong>เพิ่มไปยังหน้าจอหลัก</strong> (Install app / Add to Home screen)</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Modal รายละเอียดอาคาร -->
<div id="building-detail-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6 sm:p-8 transform transition-all duration-300 scale-95 opacity-0 modal-container" data-modal-target> 
        <div class="flex justify-between items-start mb-4 border-b pb-2">
            <h3 id="building-title" class="text-2xl font-bold text-indigo-700 flex items-center">
                <i data-lucide="building-2" class="w-6 h-6 mr-2 text-indigo-500"></i>
                รายละเอียดอาคาร
            </h3>
            <button onclick="hideModal('building-detail-modal'); stopAframeScene();" class="text-gray-500 hover:text-gray-900 transition p-1 rounded-full hover:bg-gray-100">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div class="flex space-x-2 mb-6 border-b border-gray-200">
            <button id="tab-detail" onclick="showBuildingTab('detail')" class="py-2 px-4 text-lg font-semibold text-white bg-indigo-600 rounded-t-xl transition duration-150 flex items-center shadow-md">
                <i data-lucide="info" class="w-5 h-5 mr-2"></i> ข้อมูลอาคาร
            </button>
            <button id="tab-3d" onclick="showBuildingTab('3d')" class="py-2 px-4 text-lg font-semibold text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-t-xl transition duration-150 flex items-center bg-white">
                <i data-lucide="cube" class="w-5 h-5 mr-2"></i> ดูแบบ 3D/VR
            </button>
        </div>

        <div id="building-tab-detail" class="tab-content space-y-4">
            <div id="building-image-container" class="rounded-2xl overflow-hidden shadow-xl h-60 bg-gray-200 flex items-center justify-center ring-4 ring-indigo-100"> 
                <img id="building-image" src="" alt="รูปภาพอาคาร" class="object-cover w-full h-full">
            </div>
            <p id="building-description" class="text-gray-700 p-2 bg-gray-50 rounded-xl"></p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700 p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                <div class="col-span-1 sm:col-span-2 text-indigo-800 font-bold mb-2 border-b border-indigo-200 pb-2">รายละเอียดทางเทคนิค</div>
                <p><strong>จำนวนชั้น:</strong> <span id="building-floors"></span></p>
                <p><strong>แผนกที่เกี่ยวข้อง:</strong> <span id="building-departments"></span></p>
                <p><strong>ห้องเรียน/แล็บหลัก:</strong> <span id="building-rooms"></span></p>
                <p><strong>ลิงก์แผนที่:</strong> <a id="building-map-link" href="#" target="_blank" class="text-pink-600 hover:underline font-semibold flex items-center space-x-1"><i data-lucide="navigation" class="w-4 h-4"></i><span>นำทางด้วย Google Maps</span></a></p>
            </div>
        </div>

        <div id="building-tab-3d" class="tab-content hidden">
            <div id="aframe-scene-container">
            </div>
            <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-xl shadow-md"> 
                <p class="text-blue-800 text-sm flex items-start">
                    <i data-lucide="vr-glasses" class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0"></i>
                    <strong>เคล็ดลับ:</strong> หากใช้มือถือ สามารถกดปุ่ม VR มุมขวาล่างในฉาก 3D เพื่อเข้าสู่โหมด VR/Cardboard
                </p>
            </div>
        </div>

        <button onclick="hideModal('building-detail-modal'); stopAframeScene();" class="mt-8 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-3xl shadow-xl transition duration-150 w-full flex items-center justify-center space-x-2 transform hover:scale-[0.99] ring-2 ring-red-300/50"> 
            <i data-lucide="x" class="w-5 h-5"></i>
            <span>ปิดรายละเอียด</span>
        </button>
    </div>
</div>

<!-- Container สำหรับโหมด AR/VR -->
<div id="vr-container" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center w-full h-full">
    <div id="ar-scene-container" class="w-full h-full">
        <a-scene 
            vr-mode-ui="enabled: false"
            arjs="sourceType: webcam; debugUIEnabled: false;"
            embedded
            renderer="logarithmicDepthBuffer: true;"
        >
            <!-- ตัวบ่งชี้ตำแหน่งอาคารใน AR -->
            <a-camera gps-camera rotation-reader></a-camera>
            
            <!-- ตัวบ่งชี้ตำแหน่งอาคารต่างๆ -->
            <a-entity 
                id="building-marker-1"
                gps-entity-place="latitude: 9.1399; longitude: 99.3315;"
                look-at="[gps-camera]"
            >
                <a-text 
                    value="อาคารอำนวยการ"
                    align="center"
                    color="#4f46e5"
                    scale="15 15 15"
                    position="0 10 0"
                ></a-text>
                <a-ring 
                    color="#4f46e5" 
                    radius-inner="1" 
                    radius-outer="1.5"
                    position="0 5 0"
                ></a-ring>
            </a-entity>
            
            <a-entity 
                id="building-marker-2"
                gps-entity-place="latitude: 9.1401; longitude: 99.3318;"
                look-at="[gps-camera]"
            >
                <a-text 
                    value="อาคารเทคโนโลยีสารสนเทศ"
                    align="center"
                    color="#10b981"
                    scale="15 15 15"
                    position="0 10 0"
                ></a-text>
                <a-ring 
                    color="#10b981" 
                    radius-inner="1" 
                    radius-outer="1.5"
                    position="0 5 0"
                ></a-ring>
            </a-entity>
            
            <a-entity 
                id="building-marker-3"
                gps-entity-place="latitude: 9.1403; longitude: 99.3312;"
                look-at="[gps-camera]"
            >
                <a-text 
                    value="อาคารช่างอุตสาหกรรม"
                    align="center"
                    color="#f59e0b"
                    scale="15 15 15"
                    position="0 10 0"
                ></a-text>
                <a-ring 
                    color="#f59e0b" 
                    radius-inner="1" 
                    radius-outer="1.5"
                    position="0 5 0"
                ></a-ring>
            </a-entity>
        </a-scene>
    </div>
    
    <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent z-10">
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-4 max-w-md mx-auto shadow-xl">
            <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center">
                <i data-lucide="navigation" class="w-5 h-5 mr-2 text-indigo-600"></i>
                ระบบนำทาง AR
            </h3>
            <p class="text-gray-700 text-sm mb-3">มองไปรอบๆ เพื่อดูตำแหน่งอาคารในวิทยาลัย</p>
            <div class="flex space-x-2">
                <button onclick="navigateToBuilding('b1')" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-3 rounded-xl transition duration-150 flex items-center justify-center space-x-1">
                    <i data-lucide="building" class="w-4 h-4"></i>
                    <span class="text-xs">อาคาร 1</span>
                </button>
                <button onclick="navigateToBuilding('b2')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-xl transition duration-150 flex items-center justify-center space-x-1">
                    <i data-lucide="building" class="w-4 h-4"></i>
                    <span class="text-xs">อาคาร 2</span>
                </button>
                <button onclick="navigateToBuilding('b3')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-3 rounded-xl transition duration-150 flex items-center justify-center space-x-1">
                    <i data-lucide="building" class="w-4 h-4"></i>
                    <span class="text-xs">อาคาร 3</span>
                </button>
            </div>
        </div>
    </div>
    
    <button onclick="toggleVRMode()" class="absolute top-4 right-4 z-20 bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-full shadow-lg flex items-center space-x-2 pointer-events-auto transition transform hover:scale-110 ring-2 ring-red-300/50">
        <i data-lucide="x" class="w-6 h-6"></i>
        <span class="text-sm hidden sm:inline">ปิด AR</span>
    </button>
</div>

<script>
    // ----------------------- DATA: ข้อมูลอาคารวิทยาลัยเทคนิคสุราษฎร์ธานี -----------------------
    const buildingsData = [
        {
            id: 'b1',
            name: 'อาคารอำนวยการและสำนักงาน',
            short_name: 'อาคาร 1',
            image_url: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&auto=format&fit=crop&w=1073&q=80',
            description: 'ศูนย์กลางการบริหารงานของวิทยาลัยฯ ประกอบด้วยห้องผู้อำนวยการ ห้องประชุมใหญ่ และงานทะเบียน/การเงิน',
            floors: 3,
            departments: 'สำนักงาน, ทะเบียน, การเงิน',
            rooms: 'ห้องประชุมธนากร, ห้องผู้อำนวยการ, ห้องทะเบียน',
            map_link: 'https://maps.app.goo.gl/SRtCEGpxE38W4V1F6',
            model_url: 'https://cdn.aframe.io/examples/showcase/school/School.gltf',
            latitude: 9.1399,
            longitude: 99.3315
        },
        {
            id: 'b2',
            name: 'อาคารเทคโนโลยีสารสนเทศ (IT)',
            short_name: 'อาคาร 2',
            image_url: 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?ixlib=rb-4.0.3&auto=format&fit=crop&w=1182&q=80',
            description: 'ที่ตั้งของแผนกวิชาเทคโนโลยีสารสนเทศ และห้องปฏิบัติการคอมพิวเตอร์ที่ทันสมัยหลายห้อง',
            floors: 5,
            departments: 'เทคโนโลยีสารสนเทศ, คอมพิวเตอร์ธุรกิจ',
            rooms: 'ห้องปฏิบัติการ 201-205, ห้องเรียนรวม, ห้องเซิร์ฟเวอร์',
            map_link: 'https://maps.app.goo.gl/SRtCEGpxE38W4V1F6',
            model_url: 'https://cdn.aframe.io/examples/showcase/school/School.gltf',
            latitude: 9.1401,
            longitude: 99.3318
        },
        {
            id: 'b3',
            name: 'อาคารช่างอุตสาหกรรม (ไฟฟ้า/อิเล็กทรอนิกส์)',
            short_name: 'อาคาร 3',
            image_url: 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80',
            description: 'เป็นแหล่งเรียนรู้และปฏิบัติงานด้านช่างไฟฟ้ากำลัง ช่างอิเล็กทรอนิกส์ และเครื่องมือวัดทางอุตสาหกรรม',
            floors: 4,
            departments: 'ไฟฟ้ากำลัง, อิเล็กทรอนิกส์, เครื่องกล',
            rooms: 'ห้องปฏิบัติการวงจร, ห้องทดลองมอเตอร์, โรงฝึกงาน',
            map_link: 'https://maps.app.goo.gl/SRtCEGpxE38W4V1F6',
            model_url: 'https://cdn.aframe.io/examples/showcase/school/School.gltf',
            latitude: 9.1403,
            longitude: 99.3312
        },
        {
            id: 'b4',
            name: 'อาคารปฏิบัติการวิทยาศาสตร์',
            short_name: 'อาคาร 4',
            image_url: 'https://images.unsplash.com/photo-1564059813745-7d5e4a9b2e4f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1171&q=80',
            description: 'อาคารสำหรับการเรียนการสอนและปฏิบัติการทางวิทยาศาสตร์ เคมี และฟิสิกส์',
            floors: 3,
            departments: 'วิทยาศาสตร์, เคมี, ฟิสิกส์',
            rooms: 'ห้องปฏิบัติการเคมี, ห้องปฏิบัติการฟิสิกส์, ห้องเตรียมสาร',
            map_link: 'https://maps.app.goo.gl/SRtCEGpxE38W4V1F6',
            model_url: 'https://cdn.aframe.io/examples/showcase/school/School.gltf',
            latitude: 9.1397,
            longitude: 99.3317
        },
        {
            id: 'b5',
            name: 'อาคารศิลปกรรมและออกแบบ',
            short_name: 'อาคาร 5',
            image_url: 'https://images.unsplash.com/photo-1541961017774-22349e4a1262?ixlib=rb-4.0.3&auto=format&fit=crop&w=1158&q=80',
            description: 'ศูนย์กลางการเรียนการสอนด้านศิลปะ การออกแบบ และความคิดสร้างสรรค์',
            floors: 2,
            departments: 'ศิลปกรรม, การออกแบบ',
            rooms: 'สตูดิโอศิลปะ, ห้องออกแบบ, แกลเลอรี่',
            map_link: 'https://maps.app.goo.gl/SRtCEGpxE38W4V1F6',
            model_url: 'https://cdn.aframe.io/examples/showcase/school/School.gltf',
            latitude: 9.1405,
            longitude: 99.3314
        },
        {
            id: 'b6',
            name: 'อาคารหอประชุมและกีฬา',
            short_name: 'อาคาร 6',
            image_url: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80',
            description: 'สถานที่จัดกิจกรรมใหญ่ของวิทยาลัย ทั้งการประชุม การแสดง และการแข่งขันกีฬา',
            floors: 1,
            departments: 'กิจกรรมพัฒนาผู้เรียน, กีฬา',
            rooms: 'หอประชุมใหญ่, ลานกีฬาในร่ม, ห้องเครื่องเสียง',
            map_link: 'https://maps.app.goo.gl/SRtCEGpxE38W4V1F6',
            model_url: 'https://cdn.aframe.io/examples/showcase/school/School.gltf',
            latitude: 9.1395,
            longitude: 99.3310
        }
    ];

    // ----------------------- GLOBAL VARIABLES & INIT -----------------------
    let deferredPrompt = null;
    let qrCodeInstance = null;
    let currentBuilding = null;
    let currentCameraMode = 'environment'; // 'environment' หรือ 'user'
    
    // Element References
    const homeSection = document.getElementById('home-section');
    const mapSection = document.getElementById('map-section');
    const mainContent = document.getElementById('main-content');
    const vrContainer = document.getElementById('vr-container');
    const buildingListContainer = document.getElementById('building-list');
    const buildingDetailModal = document.getElementById('building-detail-modal');
    const installQrModal = document.getElementById('install-qr-modal');
    const searchInput = document.getElementById('search-input');

    // ----------------------- CORE FUNCTIONS -----------------------

    // 1. จัดการการแสดงผล Section (Home/Map)
    window.showSection = function(sectionId) {
        document.querySelectorAll('.section-content').forEach(section => {
            section.classList.add('hidden');
        });

        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('nav a').forEach(link => {
            link.classList.remove('text-indigo-600', 'bg-indigo-50', 'rounded-xl', 'font-bold');
            link.classList.add('text-gray-700');
        });

        if (sectionId === 'home-section') {
            document.getElementById('nav-home').classList.add('text-indigo-600', 'bg-indigo-50', 'font-bold');
            document.getElementById('nav-home').classList.remove('text-gray-700');
        } else if (sectionId === 'map-section') {
            document.getElementById('nav-map').classList.add('text-indigo-600', 'bg-indigo-50', 'font-bold');
            document.getElementById('nav-map').classList.remove('text-gray-700');
        }
    }

    // 2. ฟังก์ชันแสดงรายละเอียดตึกและ 3D
    window.showBuildingDetail = function(buildingId) {
        const building = buildingsData.find(b => b.id === buildingId);
        if (!building) return;

        currentBuilding = building;

        document.getElementById('building-title').innerHTML = `<i data-lucide="building-2" class="w-6 h-6 mr-2 text-indigo-500"></i> ${building.name} (${building.short_name})`;
        document.getElementById('building-image').src = building.image_url;
        document.getElementById('building-image').alt = `รูปภาพอาคาร ${building.name}`;
        document.getElementById('building-description').textContent = building.description;
        document.getElementById('building-floors').textContent = building.floors;
        document.getElementById('building-departments').textContent = building.departments;
        document.getElementById('building-rooms').textContent = building.rooms;
        document.getElementById('building-map-link').href = building.map_link;

        showModal('building-detail-modal');
        showBuildingTab('detail', building);
        lucide.createIcons();
    }

    // 3. จัดการการสลับ Tab ใน Building Detail Modal
    window.showBuildingTab = function(tabName, building = null) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        
        document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
            btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
            btn.classList.add('text-gray-600', 'hover:text-indigo-600', 'bg-white', 'hover:bg-indigo-50');
        });

        document.getElementById(`building-tab-${tabName}`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).classList.add('bg-indigo-600', 'text-white', 'shadow-md');
        document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600', 'hover:text-indigo-600', 'bg-white', 'hover:bg-indigo-50');
        
        if (tabName === '3d' && building) {
            loadAframeScene(building.model_url);
        } else if (tabName === 'detail') {
            stopAframeScene();
        }
    }

    // 4. โหลด A-Frame Scene สำหรับแสดงผล 3D
    function loadAframeScene(modelUrl) {
        const sceneContainer = document.getElementById('aframe-scene-container');
        sceneContainer.innerHTML = '';
        
        const aframeScene = document.createElement('a-scene');
        aframeScene.setAttribute('embedded', '');
        aframeScene.setAttribute('style', 'width: 100%; height: 100%;');
        aframeScene.setAttribute('vr-mode-ui', 'enabled: true');
        
        aframeScene.innerHTML = `
            <a-assets>
                <a-asset-item id="building-model" src="${modelUrl}"></a-asset-item>
            </a-assets>
            
            <a-entity environment="preset: forest; groundColor: #445; grid: none"></a-entity>
            
            <a-entity 
                gltf-model="#building-model" 
                position="0 0 -4" 
                rotation="0 45 0" 
                scale="2 2 2"
                animation="property: rotation; to: 0 405 0; loop: true; dur: 10000"
            ></a-entity>
            
            <a-entity camera look-controls wasd-controls position="0 1.6 0"></a-entity>
            
            <a-light type="directional" color="#FFF" intensity="0.6" position="-0.5 1 1"></a-light>
            <a-light type="ambient" color="#FFF" intensity="0.4"></a-light>
            
            <a-sky color="#ECECEC"></a-sky>
        `;

        sceneContainer.appendChild(aframeScene);
    }

    // 5. หยุด A-Frame Scene
    window.stopAframeScene = function() {
        const sceneContainer = document.getElementById('aframe-scene-container');
        const aframeScene = sceneContainer.querySelector('a-scene');
        if (aframeScene) {
            aframeScene.parentNode.removeChild(aframeScene);
        }
    }

    // 6. สร้างรายการตึกใน Map Section
    function renderBuildingList() {
        buildingListContainer.innerHTML = buildingsData.map(building => `
            <div class="bg-white rounded-3xl shadow-xl hover:shadow-2xl transition duration-300 overflow-hidden border border-gray-200 flex flex-col transform hover:scale-[1.02] ring-2 ring-transparent hover:ring-indigo-300"> 
                <div class="h-44 bg-gray-200 overflow-hidden"> 
                    <img src="${building.image_url}" alt="${building.name}" class="w-full h-full object-cover transition duration-300 hover:opacity-90">
                </div>
                <div class="p-4 sm:p-6 flex flex-col flex-grow">
                    <h4 class="text-lg sm:text-xl font-extrabold text-indigo-700 mb-1 border-b pb-1">${building.name}</h4> 
                    <p class="text-sm font-semibold text-gray-500 mb-3">(${building.short_name} | ${building.floors} ชั้น)</p>
                    <p class="text-gray-600 text-sm flex-grow mb-4">${building.description.substring(0, 100)}...</p>
                    
                    <div class="flex space-x-2">
                        <button 
                            onclick="showBuildingDetail('${building.id}')" 
                            class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 sm:py-3 rounded-xl shadow-lg transition duration-150 flex items-center justify-center space-x-1 sm:space-x-2 transform hover:scale-[1.02]"
                        >
                            <i data-lucide="eye" class="w-4 h-4"></i>
                            <span class="text-xs">รายละเอียด</span>
                        </button>
                        <button 
                            onclick="navigateToBuilding('${building.id}')" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 sm:py-3 rounded-xl shadow-lg transition duration-150 flex items-center justify-center space-x-1 sm:space-x-2 transform hover:scale-[1.02]"
                        >
                            <i data-lucide="navigation" class="w-4 h-4"></i>
                            <span class="text-xs">นำทาง</span>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        lucide.createIcons();
    }

    // 7. ฟังก์ชันค้นหาห้อง
    window.searchRoom = function() {
        const query = searchInput.value.toLowerCase().trim();
        if (!query) return;
        
        // ค้นหาในข้อมูลอาคาร
        let found = false;
        buildingsData.forEach(building => {
            if (building.rooms.toLowerCase().includes(query) || 
                building.name.toLowerCase().includes(query) ||
                building.departments.toLowerCase().includes(query)) {
                
                showBuildingDetail(building.id);
                found = true;
            }
        });
        
        if (!found) {
            alert(`ไม่พบ "${query}" ในวิทยาลัยเทคนิคสุราษฎร์ธานี`);
        }
    }

    // 8. ฟังก์ชันนำทางไปยังอาคาร
    window.navigateToBuilding = function(buildingId) {
        const building = buildingsData.find(b => b.id === buildingId);
        if (!building) return;
        
        // ถ้ายังไม่ได้เปิดโหมด AR ให้เปิดก่อน
        if (vrContainer.classList.contains('hidden')) {
            showCameraSelection();
        } else {
            // แสดงคำแนะนำการนำทาง
            setTimeout(() => {
                alert(`กำลังนำทางไปยัง ${building.name}\n\nโปรดมองผ่านกล้องไปยังทิศทางของอาคารที่แสดงใน AR`);
            }, 1000);
        }
    }

    // 9. ฟังก์ชันแสดง Modal เลือกกล้อง
    window.showCameraSelection = function() {
        showModal('camera-selection-modal');
    }

    // ----------------------- PWA, QR CODE, MODAL, AR/VR -----------------------

    // [PWA Logic]
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => { 
                    console.log('SW registered: ', registration); 
                })
                .catch(registrationError => { 
                    console.log('SW registration failed: ', registrationError); 
                });
        });
    }
    
    window.addEventListener('beforeinstallprompt', (e) => { 
        e.preventDefault(); 
        deferredPrompt = e;
        document.getElementById('pwa-install-button').classList.remove('hidden');
    });
    
    window.promptPWAInstall = function() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') { 
                    console.log('User accepted the install prompt'); 
                } else { 
                    console.log('User dismissed the install prompt'); 
                }
                deferredPrompt = null;
                document.getElementById('pwa-install-button').classList.add('hidden'); 
            });
        }
    }

    // [Modal Logic]
    window.showModal = function(id) {
        const modal = document.getElementById(id);
        const modalTarget = modal.querySelector('[data-modal-target]');

        modal.classList.remove('hidden');
        modal.offsetHeight; 
        
        if(modalTarget) {
            modalTarget.classList.remove('scale-95', 'opacity-0');
            modalTarget.classList.add('scale-100', 'opacity-100');
        }

        mainContent.classList.add('pointer-events-none', 'blur-sm');
        lucide.createIcons(); 
        if (id === 'install-qr-modal') {
            generateQRCodeForApp();
        }
    }
    
    window.hideModal = function(id) {
        const modal = document.getElementById(id);
        const modalTarget = modal.querySelector('[data-modal-target]');
        
        if(modalTarget) {
             modalTarget.classList.add('scale-95', 'opacity-0');
             modalTarget.classList.remove('scale-100', 'opacity-100');
             
             setTimeout(() => {
                 modal.classList.add('hidden');
                 mainContent.classList.remove('pointer-events-none', 'blur-sm');
             }, 300);
        } else {
             modal.classList.add('hidden');
             mainContent.classList.remove('pointer-events-none', 'blur-sm');
        }
    }

    // [QR Code Logic]
    function generateQRCodeForApp() {
        const url = window.location.href; 
        const qrcodeDisplay = document.getElementById('qrcode-display');
        qrcodeDisplay.innerHTML = '<div class="text-gray-500 text-sm">กำลังสร้าง QR Code...</div>';
        qrCodeInstance = new QRCode(qrcodeDisplay, {
            text: url,
            width: 200,
            height: 200,
            colorDark: "#1f2937", 
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        setTimeout(() => { lucide.createIcons(); }, 100); 
    }
    
    window.downloadQRCode = function() {
        const qrcodeDisplay = document.getElementById('qrcode-display');
        const canvas = qrcodeDisplay.querySelector('canvas');
        const img = qrcodeDisplay.querySelector('img');
        let dataUrl;
        if (canvas) { 
            dataUrl = canvas.toDataURL("image/png"); 
        } else if (img) { 
            dataUrl = img.src; 
        }
        if (dataUrl) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `srtc_vr_navigation_qrcode.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else { 
            console.error("QR Code image not found."); 
        }
    }

    // [AR/VR Logic]
    window.toggleVRMode = function(cameraMode = null) {
        if (cameraMode) {
            currentCameraMode = cameraMode;
            hideModal('camera-selection-modal');
        }
        
        const isVRActive = !vrContainer.classList.contains('hidden');
        
        if (!isVRActive) {
            // เปิดโหมด AR
            homeSection.classList.add('hidden');
            mapSection.classList.add('hidden'); 
            mainContent.classList.add('hidden'); 
            vrContainer.classList.remove('hidden');
            
            // ตรวจสอบการรองรับ AR
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('อุปกรณ์ของคุณไม่รองรับการใช้งานกล้องสำหรับ AR');
                toggleVRMode();
                return;
            }
            
            // ขออนุญาตใช้งานกล้องตามโหมดที่เลือก
            const constraints = {
                video: { 
                    facingMode: currentCameraMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(() => {
                    console.log('Camera access granted for mode:', currentCameraMode);
                })
                .catch(err => {
                    console.error('Camera access denied:', err);
                    alert('ต้องอนุญาตการใช้งานกล้องเพื่อเปิดโหมด AR');
                    toggleVRMode();
                });
        } else {
            // ปิดโหมด AR
            vrContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            homeSection.classList.remove('hidden'); 
        }
        lucide.createIcons();
    }

    // ----------------------- INITIALIZATION -----------------------
    window.addEventListener('load', () => {
        lucide.createIcons(); 
        renderBuildingList();
        showSection('home-section');
        
        // ตั้งค่าการค้นหาด้วยปุ่ม Enter
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchRoom();
            }
        });
        
        // ป้องกันการเลื่อนหน้าเว็บเมื่อเปิด Modal
        document.addEventListener('touchmove', function(e) {
            if (!vrContainer.classList.contains('hidden')) {
                e.preventDefault();
            }
        }, { passive: false });
    });

</script>

</body>
</html>
